{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaleTailor - Find Your Stories</title>
    <link rel="icon" type="image/png" href="{% static 'images/fav.jpg' %}">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Styles -->
    <link rel="stylesheet" href="{% static 'css/home_modern.css' %}">
    <link rel="stylesheet" href="{% static 'css/explore_modern.css' %}">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
</head>

<body>
    <!-- Background Elements -->
    <div class="hero-bg-glow"></div>

    <header>
        <div class="header-container">
            <a href="{% url 'authentication:home' %}" class="logo">TALETAILOR</a>

            <nav class="nav-links">
                <a href="{% url 'authentication:home' %}" class="nav-link">HOME</a>
                <a href="{% url 'mystory:mystory1' %}" class="nav-link">STORY</a>
                <a href="{% url 'aistory:explore' %}" class="nav-link active">EXPLORE</a>
                {% if user.is_superuser %}
                <a href="{% url 'authentication:dashboard' %}" class="nav-link">ADMIN</a>
                {% endif %}
            </nav>

            <div class="user-actions">
                <a href="{% url 'mystory:collaboration_requests' %}" class="icon-btn" title="Requests">
                    <i class="fas fa-heart"></i>
                </a>
                <a href="{% url 'messaging:chat' %}" class="icon-btn" title="Messages">
                    <i class="fas fa-comment-alt"></i>
                </a>
                <a href="#" class="icon-btn" data-bs-toggle="modal" data-bs-target="#profileModal" title="Profile">
                    <i class="fas fa-user"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true" style="backdrop-filter: blur(5px);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background: var(--bg-dark); border: 1px solid var(--glass-border); color: white;">
                <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
                    <h5 class="modal-title">Profile Options</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-3">
                        <a href="{% url 'authentication:view_profile' %}" class="btn btn-outline-light"><i
                                class="fas fa-user me-2"></i> Profile</a>
                        <a href="{% url 'mystory:mystory1' %}" class="btn btn-outline-light"><i
                                class="fas fa-book-open me-2"></i> My Story</a>
                        <a href="#" class="btn btn-outline-light"><i class="fas fa-cog me-2"></i> Settings</a>
                       {% if request.user.is_authenticated %}
                      <a href="{% url 'authentication:logout' %}" class="btn btn-outline-danger btn-sm shadow-sm d-inline-flex align-items-center">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                      </a>
                    {% else %}
                      <a href="{% url 'authentication:login' %}" class="btn btn-outline-primary btn-sm shadow-sm d-inline-flex align-items-center">
                        <i class="fas fa-sign-in-alt me-2"></i> Login
                      </a>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="explore-container">
        <!-- Sidebar Filters -->
        <aside class="filters-sidebar glass-panel p-4" data-aos="fade-right">
            <form method="GET" action="{% url 'aistory:explore' %}" id="filter-form">

                <div class="search-container">
                    <input type="text" name="search" class="search-box" placeholder="Search stories..."
                        value="{{ search_query|default:'' }}">
                </div>

                <!-- Length Filter -->
                <div class="filter-group">
                    <div class="filter-toggle">
                        <span><i class="fas fa-clock fs-5 me-2"></i> Length</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="filter-options">
                        <label class="custom-checkbox">
                            {% if "short" in selected_lengths %}
                            <input type="checkbox" name="length" value="short" checked>
                            {% else %}
                            <input type="checkbox" name="length" value="short">
                            {% endif %}
                            Short (< 500 words) </label>
                                <label class="custom-checkbox">
                                    {% if "medium" in selected_lengths %}
                                    <input type="checkbox" name="length" value="medium" checked>
                                    {% else %}
                                    <input type="checkbox" name="length" value="medium">
                                    {% endif %}
                                    Medium (500 - 1500)
                                </label>
                                <label class="custom-checkbox">
                                    {% if "long" in selected_lengths %}
                                    <input type="checkbox" name="length" value="long" checked>
                                    {% else %}
                                    <input type="checkbox" name="length" value="long">
                                    {% endif %}
                                    Long (> 1500 words)
                                </label>
                    </div>
                </div>

                <!-- Type/Genre Filter -->
                <div class="filter-group">
                    <div class="filter-toggle">
                        <span><i class="fas fa-book fs-5 me-2"></i> Type</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="filter-options">
                        <label class="custom-checkbox">
                            {% if "fantasy" in selected_types %}
                            <input type="checkbox" name="type" value="fantasy" checked>
                            {% else %}
                            <input type="checkbox" name="type" value="fantasy">
                            {% endif %}
                            Fantasy
                        </label>
                        <label class="custom-checkbox">
                            {% if "mystery" in selected_types %}
                            <input type="checkbox" name="type" value="mystery" checked>
                            {% else %}
                            <input type="checkbox" name="type" value="mystery">
                            {% endif %}
                            Mystery
                        </label>
                        <label class="custom-checkbox">
                            {% if "scifi" in selected_types %}
                            <input type="checkbox" name="type" value="scifi" checked>
                            {% else %}
                            <input type="checkbox" name="type" value="scifi">
                            {% endif %}
                            Sci-Fi
                        </label>
                        <label class="custom-checkbox">
                            {% if "romance" in selected_types %}
                            <input type="checkbox" name="type" value="romance" checked>
                            {% else %}
                            <input type="checkbox" name="type" value="romance">
                            {% endif %}
                            Romance
                        </label>
                        <label class="custom-checkbox">
                            {% if "horror" in selected_types %}
                            <input type="checkbox" name="type" value="horror" checked>
                            {% else %}
                            <input type="checkbox" name="type" value="horror">
                            {% endif %}
                            Horror
                        </label>
                    </div>
                </div>

                <!-- Emotion Filter -->
                <div class="filter-group">
                    <div class="filter-toggle">
                        <span><i class="fas fa-heart fs-5 me-2"></i> Emotion</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="filter-options">
                        <label class="custom-checkbox">
                            {% if "happy" in selected_emotions %}
                            <input type="checkbox" name="emotion" value="happy" checked>
                            {% else %}
                            <input type="checkbox" name="emotion" value="happy">
                            {% endif %}
                            Happy
                        </label>
                        <label class="custom-checkbox">
                            {% if "sad" in selected_emotions %}
                            <input type="checkbox" name="emotion" value="sad" checked>
                            {% else %}
                            <input type="checkbox" name="emotion" value="sad">
                            {% endif %}
                            Sad
                        </label>
                        <label class="custom-checkbox">
                            {% if "suspenseful" in selected_emotions %}
                            <input type="checkbox" name="emotion" value="suspenseful" checked>
                            {% else %}
                            <input type="checkbox" name="emotion" value="suspenseful">
                            {% endif %}
                            Suspenseful
                        </label>
                        <label class="custom-checkbox">
                            {% if "scary" in selected_emotions %}
                            <input type="checkbox" name="emotion" value="scary" checked>
                            {% else %}
                            <input type="checkbox" name="emotion" value="scary">
                            {% endif %}
                            Scary
                        </label>
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="submit" class="cta-button btn-pulse w-100">Apply</button>
                    <a href="{% url 'aistory:explore' %}" class="btn-clear">Clear</a>
                </div>
            </form>
        </aside>

        <!-- Main Content -->
        <main class="explore-content">
            <div class="controls-bar glass-panel" data-aos="fade-down">
                <div class="results-info">
                    <p>
                        Showing <strong>{{ page_obj|length }}</strong> of
                        <strong>{{ page_obj.paginator.count }}</strong> stories
                    </p>
                </div>
                <div class="view-toggles">
                    <button class="view-btn active" id="grid-view" title="Grid View"><i
                            class="fas fa-th-large"></i></button>
                    <button class="view-btn" id="list-view" title="List View"><i class="fas fa-list"></i></button>
                </div>
            </div>

            <div id="stories-container" class="stories-grid">
                {% for story in page_obj %}
                <a href="{% url 'aistory:view_story' story.id %}" style="text-decoration: none;">
                    <article class="explore-card" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:100 }}">
                        <div class="card-image-container">
                            {% if story.image %}
                            <img src="{{ story.image.url }}" alt="{{ story.title }}">
                            {% else %}
                            <img src="{% static 'images/logo4.webp' %}" alt="{{ story.title }}">
                            {% endif %}
                            <span class="card-category-badge">{{ story.emotions|default:"Story" }}</span>
                        </div>
                        <div class="card-details">
                            <h3 class="card-title">{{ story.title }}</h3>
                            <div class="grid-tags">
                                <span class="grid-tag">{{ story.get_length_display }}</span>
                                {% if story.is_collaborated %}
                                <span class="grid-tag">Collab</span>
                                {% endif %}
                            </div>

                            <!-- Description for List View (Hidden in grid via CSS if needed, shown in list) -->
                            <p class="list-description d-none">{{ story.content|truncatewords:30 }}</p>

                            <div class="card-meta">
                                <span class="meta-item" title="Views">
                                    <i class="fas fa-eye text-primary"></i>
                                    <span class="fw-bold ms-1">{{ story.view_count|default:"0" }}</span>
                                </span>
                                <span class="meta-item" title="Likes">
                                    <i class="fas fa-heart text-danger"></i>
                                    <span class="fw-bold ms-1">{{ story.like_count|default:"0" }}</span>
                                </span>
                            </div>
                        </div>
                    </article>
                </a>
                {% empty %}
                <div class="glass-panel p-5 text-center w-100">
                    <i class="fas fa-ghost fa-3x mb-3 text-muted"></i>
                    <h3>No stories found</h3>
                    <p class="text-muted">Try adjusting your filters or search query.</p>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="pagination-container">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                    class="page-link"><i class="fas fa-chevron-left"></i></a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <span class="page-link active">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <a
                    href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                    class="page-link">{{ num }}</a>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}"
                        class="page-link"><i class="fas fa-chevron-right"></i></a>
                    {% endif %}
            </div>
            {% endif %}
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            AOS.init({
                duration: 800,
                once: true,
                offset: 50
            });

            // Filter Accordions
            document.querySelectorAll('.filter-toggle').forEach(toggle => {
                toggle.addEventListener('click', function () {
                    const options = this.nextElementSibling;
                    const icon = this.querySelector('.fa-chevron-down, .fa-chevron-up');

                    if (options.style.display === 'flex') {
                        options.style.display = 'none';
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        options.style.display = 'flex';
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                });
            });

            // Default open for first group if specific logic isn't needed
            document.querySelectorAll('.filter-options').forEach(el => {
                if (el.querySelector('input:checked')) {
                    el.style.display = 'flex';
                }
            });

            // View Toggle Logic
            const gridBtn = document.getElementById('grid-view');
            const listBtn = document.getElementById('list-view');
            const container = document.getElementById('stories-container');
            const descriptions = document.querySelectorAll('.list-description');

            gridBtn.addEventListener('click', () => {
                container.classList.remove('stories-list-layout');
                container.classList.add('stories-grid');
                gridBtn.classList.add('active');
                listBtn.classList.remove('active');
                descriptions.forEach(el => el.classList.add('d-none'));
            });

            listBtn.addEventListener('click', () => {
                container.classList.remove('stories-grid');
                container.classList.add('stories-list-layout');
                listBtn.classList.add('active');
                gridBtn.classList.remove('active');
                descriptions.forEach(el => el.classList.remove('d-none'));
            });
        });
    </script>
</body>

</html>