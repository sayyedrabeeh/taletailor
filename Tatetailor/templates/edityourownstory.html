{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Story Editor - TaleTailor</title>
<link rel="icon" type="image/png" href="{% static 'images/fav.jpg' %}">
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'css/editstory_modern.css' %}">

  <!-- AOS Animation -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

  <style>
    #loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      z-index: 10000;
      box-shadow: 0 0 50px rgba(140, 82, 255, 0.3);
      border: 1px solid var(--glass-border);
      text-align: center;
      color: white;
    }

    #loader img {
      width: 60px;
      margin-bottom: 15px;
    }

    .typing-indicator {
      font-size: 0.9rem;
      color: var(--accent-secondary);
      margin-bottom: 10px;
      font-weight: 500;
      display: none;
    }

    .owner-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      background: rgba(140, 82, 255, 0.1);
      border: 1px solid var(--accent-primary);
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--accent-primary);
      margin-bottom: 15px;
      text-transform: uppercase;
    }
  </style>
</head>

<body data-is-owner="{{ is_owner|yesno:'true,false' }}" data-status="{{ status }}">
  <!-- Background Elements -->
  <div class="hero-bg-glow"></div>

  <header>
    <div class="header-container">
      <a href="{% url 'authentication:home' %}" class="logo">TALETAILOR</a>

      <nav class="nav-links">
        <a href="{% url 'authentication:home' %}" class="nav-link">HOME</a>
        <a href="{% url 'mystory:mystory1' %}" class="nav-link">STORY</a>
        <a href="{% url 'aistory:explore' %}" class="nav-link">EXPLORE</a>
        {% if user.is_superuser %}
        <a href="{% url 'authentication:dashboard' %}" class="nav-link">ADMIN</a>
        {% endif %}
      </nav>

      <div class="user-actions">
        <a href="{% url 'mystory:collaboration_requests' %}" class="icon-btn" title="Requests">
          <i class="fas fa-heart"></i>
        </a>
        <a href="{% url 'messaging:chat' %}" class="icon-btn" title="Messages">
          <i class="fas fa-comment-alt"></i>
        </a>
        <a href="#" class="icon-btn" data-bs-toggle="modal" data-bs-target="#profileModal" title="Profile">
          <i class="fas fa-user"></i>
        </a>
      </div>
    </div>
  </header>

  <!-- Profile Modal -->
  <div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true" style="backdrop-filter: blur(10px);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content"
        style="background: var(--bg-dark); border: 1px solid var(--glass-border); color: white; border-radius: 24px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--glass-border);">
          <h5 class="modal-title">Profile Options</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-grid gap-3">
            <a href="{% url 'authentication:view_profile' %}" class="btn btn-outline-light"
              style="border-radius: 12px;"><i class="fas fa-user me-2"></i> Profile</a>
            <a href="{% url 'mystory:mystory1' %}" class="btn btn-outline-light" style="border-radius: 12px;"><i
                class="fas fa-book-open me-2"></i>
              My Story</a>
            <a href="#" class="btn btn-outline-light" style="border-radius: 12px;"><i class="fas fa-cog me-2"></i>
              Settings</a>
            <a href="{% url 'authentication:logout' %}" class="btn btn-outline-danger" style="border-radius: 12px;"><i
                class="fas fa-sign-out-alt me-2"></i> Logout</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <form id="storyForm" method="POST"
      action="{% if story11 %}{% url 'mystory:edit_story' sid %}{% else %}{% url 'mystory:edit_story' %}{% endif %}"
      class="w-100 d-flex gap-4">
      {% csrf_token %}

      <div class="editor-main" data-aos="fade-right">
        {% if messages %}
        <div class="messages-container">
          {% for message in messages %}
          <div class="alert alert-dismissible fade show {% if message.tags %}alert-{{ message.tags }}{% endif %}"
            role="alert"
            style="background: var(--glass-bg); color: white; border: 1px solid var(--glass-border); border-radius: 16px;">
            {{ message }}
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <div class="glass-panel">
          {% if is_owner %}
          <div class="owner-badge"><i class="fas fa-crown"></i> Owner</div>
          {% endif %}

          <input type="text" name="title" id="storyTitle" class="title-input" placeholder="Title your story..."
            value="{{ title|default:'' }}" required>

          {% if story.image %}
          <img src="{{ story.image.url }}" alt="Story Image" class="story-image mb-4"
            style="width: 100%; border-radius: 16px; border: 1px solid var(--glass-border);">
          {% endif %}

          <div class="typing-indicator" id="typingIndicator">‚úçÔ∏è Someone is typing...</div>

          <div class="alert alert-warning text-center mt-2 mb-3" id="edit-warning"
            style="display:none; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); color: var(--warning); border-radius: 12px;">
            <i class="fas fa-exclamation-triangle"></i> You cannot edit this story. Only the owner can edit published
            stories.
          </div>

          <textarea name="story" id="storyContent" class="story-editor"
            placeholder="Once upon a time...">{{ story11|default:'' }}</textarea>
        </div>
      </div>

      <aside class="editor-sidebar" data-aos="fade-left">
        <div class="glass-panel sidebar-panel">
          {% if story11 %}
          {% if is_collaborator and not is_owner %}
          <h3 class="section-title"><i class="fas fa-users-cog"></i> Collaboration</h3>
          <div class="button-stack">
            {% if status == "public" or status == "private" %}
            <a href="{% url 'mystory:download_story' sid %}" class="btn-pulse btn-download"
              style="text-decoration: none;">
              <i class="fas fa-download"></i> Download PDF
            </a>
            <a href="{% url 'mystory:share_story' sid %}" class="btn-pulse btn-share" style="text-decoration: none;">
              <i class="fas fa-share-alt"></i> Share Story
            </a>
            {% endif %}
          </div>
          {% elif is_owner %}
          <h3 class="section-title"><i class="fas fa-cog"></i> Management</h3>
          <div class="button-stack">
            {% if status == "public" or status == "private" %}
            <a href="{% url 'mystory:download_story' sid %}" class="btn-pulse btn-download"
              style="text-decoration: none;">
              <i class="fas fa-download"></i> Download PDF
            </a>
            <a href="{% url 'mystory:share_story' sid %}" class="btn-pulse btn-share" style="text-decoration: none;">
              <i class="fas fa-share-alt"></i> Share Story
            </a>
            {% endif %}

            {% if status != "public" and status != "private" %}
            <div class="preference-group">
              <label class="preference-label">Initial Preferences</label>
              <div class="radio-grid mb-3">
                <label class="option-box">
                  <input type="radio" name="length" value="short">
                  <span class="option-label">Short</span>
                </label>
                <label class="option-box">
                  <input type="radio" name="length" value="medium">
                  <span class="option-label">Medium</span>
                </label>
                <label class="option-box">
                  <input type="radio" name="length" value="long">
                  <span class="option-label">Long</span>
                </label>
              </div>

            <select name="emotion" class="modern-select mb-3">
              <option value="" disabled selected>Select Emotion</option>
              <option value="happy">Happy</option>
              <option value="sad">Sad</option>
              <option value="romantic">Romantic</option>
              <option value="thriller">Thrilling</option>
              <option value="adventure">Adventure</option>
              <option value="mystery">Mysterious</option>
              <option value="comedy">Comedy</option>
              <option value="horror">Horror</option>
              <option value="fantasy">Fantasy</option>
              <option value="scifi">Sci-Fi</option>
              <option value="inspirational">Inspirational</option>
              <option value="melancholy">Melancholy</option>
              <option value="anger">Anger</option>
              <option value="surprise">Surprise</option>
              <option value="fear">Fear</option>
            </select>

              <select name="theme" class="modern-select">
                <option value="" disabled selected>Select Theme</option>
                <option value="fantasy">Fantasy</option>
                <option value="adventure">Adventure</option>
                <option value="horror">Horror</option>
                <option value="sci-fi">Sci-Fi</option>
                <option value="historical">Historical</option>
                <option value="drama">Drama</option>
              </select>
            </div>

            <div class="button-stack">
              <button type="submit" name="post_type" value="public" class="btn-pulse btn-save">
                <i class="fas fa-globe"></i> Post Publicly
              </button>
              <button type="submit" name="post_type" value="private" class="btn-pulse btn-download">
                <i class="fas fa-lock"></i> Post Privately
              </button>
            </div>
            {% endif %}
          </div>
          {% endif %}
          {% else %}
          <h3 class="section-title"><i class="fas fa-edit"></i> Creation</h3>
          <div class="preference-group">
            <label class="preference-label">Story Preferences</label>
            <div class="radio-grid mb-3">
              <label class="option-box">
                <input type="radio" name="length" value="short">
                <span class="option-label">Short</span>
              </label>
              <label class="option-box">
                <input type="radio" name="length" value="medium">
                <span class="option-label">Medium</span>
              </label>
              <label class="option-box">
                <input type="radio" name="length" value="long">
                <span class="option-label">Long</span>
              </label>
            </div>

           

           <select name="emotion" class="modern-select mb-3">
             <option value="" disabled selected>Select Emotion</option>
             <option value="happy">Happy</option>
             <option value="sad">Sad</option>
             <option value="romantic">Romantic</option>
             <option value="thriller">Thrilling</option>
             <option value="adventure">Adventure</option>
             <option value="mystery">Mysterious</option>
             <option value="comedy">Comedy</option>
             <option value="horror">Horror</option>
             <option value="fantasy">Fantasy</option>
             <option value="scifi">Sci-Fi</option>
             <option value="inspirational">Inspirational</option>
             <option value="melancholy">Melancholy</option>
             <option value="anger">Anger</option>
             <option value="surprise">Surprise</option>
             <option value="fear">Fear</option>
           </select>

            <select name="theme" class="modern-select">
              <option value="" disabled selected>Select Theme</option>
              <option value="fantasy">Fantasy</option>
              <option value="adventure">Adventure</option>
              <option value="horror">Horror</option>
              <option value="sci-fi">Sci-Fi</option>
              <option value="historical">Historical</option>
              <option value="drama">Drama</option>
            </select>
          </div>

          <div class="button-stack">
            <button type="submit" name="post_type" value="public" class="btn-pulse btn-save">
              <i class="fas fa-globe"></i> Post Publicly
            </button>
            <button type="submit" name="post_type" value="private" class="btn-pulse btn-download">
              <i class="fas fa-lock"></i> Post Privately
            </button>
          </div>
          {% endif %}

          <div class="word-count" id="wordCountDisplay">
            Words: <span id="wordCount">0</span> | Characters: <span id="charCount">0</span>
          </div>
        </div>

         
      </aside>
    </form>
  </main>

  <div id="loader" style="display:none;">
    <img src="{% static 'images/loader.gif' %}" alt="Loading..." />
    <p style="margin: 0; font-weight: 600;">Sending story to followers...</p>
  </div>

  <footer class="main-footer">
    <div class="footer-content">
      <div class="footer-brand">
        <h2>Taletailor</h2>
        <p class="footer-tagline">Where passion meets precision. Capturing the essence of every detail, one story at a
          time.</p>
      </div>
      <div class="footer-col">
        <h3 style="color: white; font-size: 1.2rem; margin-bottom: 1.5rem;">Services</h3>
        <div class="footer-links" style="display: flex; flex-direction: column; gap: 10px;">
          <a href="#" class="nav-link"
            style="padding: 0; background: none; text-transform: none; color: var(--text-muted);">Bonus Program</a>
          <a href="#" class="nav-link"
            style="padding: 0; background: none; text-transform: none; color: var(--text-muted);">Gift Cards</a>
          <a href="#" class="nav-link"
            style="padding: 0; background: none; text-transform: none; color: var(--text-muted);">Subscription</a>
        </div>
      </div>
      <div class="footer-col">
        <h3 style="color: white; font-size: 1.2rem; margin-bottom: 1.5rem;">Support</h3>
        <div class="footer-links" style="display: flex; flex-direction: column; gap: 10px;">
          <a href="#" class="nav-link"
            style="padding: 0; background: none; text-transform: none; color: var(--text-muted);">Help Center</a>
          <a href="#" class="nav-link"
            style="padding: 0; background: none; text-transform: none; color: var(--text-muted);">Terms of Use</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Initialize AOS
      AOS.init({ duration: 800, once: true });

      const form = document.getElementById("storyForm");
      const loader = document.getElementById("loader");

      form.addEventListener("submit", () => {
        loader.style.display = "block";
      });

      const editorTextarea = document.getElementById('storyContent');
      const titleInput = document.getElementById('storyTitle');
      const wordCountSpan = document.getElementById('wordCount');
      const charCountSpan = document.getElementById('charCount');
      const currentUserId = "{{ request.user.id }}";
      const currentUsername = "{{ request.user.username }}";

      let suppressBroadcast = false;
      let typingTimeout;

      function updateWordCount() {
        const text = editorTextarea.value;
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        const characters = text.length;
        wordCountSpan.textContent = words;
        charCountSpan.textContent = characters;
      }

      updateWordCount();
      editorTextarea.addEventListener('input', updateWordCount);

      // Get story status & owner info
      const isOwner = document.body.dataset.isOwner === "true";
      const status = document.body.dataset.status;
      const isPosted = ["public", "private"].includes(status);
      const canEdit = isOwner || (!isPosted);

      if (!canEdit) {
        editorTextarea.disabled = true;
        titleInput.disabled = true;
        const warning = document.getElementById("edit-warning");
        if (warning) warning.style.display = "block";
      }

      const storyId = "{{ sid }}";
      const roomName = `story-${storyId}`;
      const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
      const socket = new WebSocket(`${wsProtocol}://${window.location.host}/ws/story/${roomName}/`);

      console.log("Connecting to WebSocket:", roomName);

      socket.onopen = () => console.log("‚úÖ WebSocket connected");
      socket.onerror = (e) => console.error("‚ùå WebSocket error:", e);
      socket.onclose = () => console.warn("‚ö†Ô∏è WebSocket closed");

      socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log("üì© Message received:", data);

        if (data.type === "initial" || data.type === "broadcast_edit") {
          suppressBroadcast = true;

          if (data.content !== undefined && data.content !== editorTextarea.value) {
            if (document.activeElement !== editorTextarea) {
              editorTextarea.value = data.content;
              updateWordCount();
            }
          }

          if (data.title !== undefined && data.title !== titleInput.value && document.activeElement !== titleInput) {
            titleInput.value = data.title;
          }

          suppressBroadcast = false;
        }

        const typingIndicator = document.getElementById("typingIndicator");

        if (data.type === "user_typing") {
          if (data.user_id !== currentUserId && data.is_typing) {
            typingIndicator.textContent = `‚úçÔ∏è ${data.username} is typing...`;
            typingIndicator.style.display = "block";
            editorTextarea.disabled = true;
            titleInput.disabled = true;

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
              typingIndicator.style.display = "none";
              if (canEdit) {
                editorTextarea.disabled = false;
                titleInput.disabled = false;
              }
            }, 3000);
          }
        }

        if (data.type === "error") {
          alert(data.message);
        }
      };

      function debounce(func, wait) {
        let timeout;
        return function () {
          clearTimeout(timeout);
          timeout = setTimeout(func, wait);
        };
      }

      const sendUpdate = debounce(() => {
        if (!canEdit || suppressBroadcast || socket.readyState !== WebSocket.OPEN) return;

        socket.send(JSON.stringify({
          type: "broadcast_edit",
          title: titleInput.value,
          content: editorTextarea.value,
          user_id: currentUserId,
          username: currentUsername,
        }));
      }, 300);

      function sendTyping() {
        if (!canEdit || socket.readyState !== WebSocket.OPEN) return;

        socket.send(JSON.stringify({
          type: "user_typing",
          is_typing: true,
          user_id: currentUserId,
          username: currentUsername
        }));
      }

      const notifyTyping = debounce(sendTyping, 300);

      editorTextarea.addEventListener("input", () => {
        sendUpdate();
        notifyTyping();
      });

      titleInput.addEventListener("input", () => {
        sendUpdate();
        notifyTyping();
      });
    });
  </script>
</body>

</html>